<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能源管理法隨機填充題測驗（自適應寬度版）</title>
    <style>
        body {
            font-family: '微軟正黑體', 'Microsoft JhengHei', sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #1a5276;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #1a5276;
        }
        h2 {
            color: #2874a6;
            margin-top: 30px;
            background-color: #eaf2f8;
            padding: 8px;
            border-radius: 5px;
        }
        .quiz-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .question {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ddd;
        }
        .article-content {
            padding-left: 20px;
            margin-top: 10px;
        }
        .paragraph {
            margin-bottom: 10px;
            text-indent: 2em;
            position: relative;
        }
        .article-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        input[type="text"] {
            border: none;
            border-bottom: 1px solid #3498db;
            padding: 5px 2px;
            margin: 0 2px;
            font-family: inherit;
            font-size: inherit;
            color: #e74c3c;
            background-color: #f9f9f9;
            vertical-align: middle;
            min-width: 20px; /* 設置最小寬度 */
            box-sizing: border-box;
        }
        input[type="text"]:focus {
            outline: none;
            border-bottom: 2px solid #2980b9;
            background-color: #ecf0f1;
        }
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        button {
            background-color: #2980b9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1a5276;
        }
        #reset {
            background-color: #95a5a6;
        }
        #reset:hover {
            background-color: #7f8c8d;
        }
        #regenerate {
            background-color: #27ae60;
        }
        #regenerate:hover {
            background-color: #2ecc71;
        }
        .difficulty-controls {
            display: flex;
            align-items: center;
            margin: 20px 0;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        .difficulty-controls label {
            margin-right: 15px;
            font-weight: bold;
        }
        .difficulty-controls select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }
        .progress-container {
            margin: 20px 0;
        }
        .progress {
            background-color: #ecf0f1;
            border-radius: 20px;
            height: 10px;
            overflow: hidden;
        }
        .progress-bar {
            background-color: #3498db;
            height: 100%;
            width: 0%;
            transition: width 0.5s;
        }
        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
        }
        .blank {
            display: inline-block;
            min-width: 50px;
            border-bottom: 1px solid #3498db;
            text-align: center;
            color: #e74c3c;
        }
        .hint {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* 評分模態框樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto; /* 允許垂直滾動 */
        }
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: 5% auto; /* 調整上邊距使整個模態框可見 */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            animation: modalAppear 0.3s ease-out;
            max-height: 90vh; /* 設置最大高度 */
            overflow-y: auto; /* 內容太多時允許垂直滾動 */
        }
        @keyframes modalAppear {
            from {transform: translateY(-50px); opacity: 0;}
            to {transform: translateY(0); opacity: 1;}
        }
        .modal-header {
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
            background-color: transparent;
            padding: 0;
        }
        .close-button {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #7f8c8d;
            cursor: pointer;
        }
        .close-button:hover {
            color: #34495e;
        }
        .score-display {
            text-align: center;
            margin: 20px 0;
        }
        .score-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #eaf2f8;
            border: 10px solid #3498db;
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .score-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .score-details p {
            margin: 10px 0;
            font-size: 16px;
        }
        .grade {
            font-size: 24px;
            font-weight: bold;
            color: #27ae60;
            margin: 15px 0;
        }
        .feedback {
            font-style: italic;
            color: #7f8c8d;
            margin: 15px 0;
        }
        .modal-actions {
            text-align: center;
            margin-top: 20px;
            padding-bottom: 15px; /* 確保底部按鈕有足夠空間 */
        }
        .correct-answer {
            background-color: #d4edda !important;
            border-bottom: 2px solid #28a745 !important;
        }
        .wrong-answer {
            background-color: #f8d7da !important;
            border-bottom: 2px solid #dc3545 !important;
        }
        .results-button {
            background-color: #e74c3c;
        }
        .results-button:hover {
            background-color: #c0392b;
        }
        
        /* 法條條項款目樣式 */
        .item {
            margin-bottom: 8px;
            padding-left: 2em;
            text-indent: -2em;
        }
        .item-number {
            margin-right: 0.5em;
            font-weight: bold;
        }
        .sub-paragraph {
            margin-top: 10px;
            padding-left: 2em;
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <h1>能源管理法隨機填充題測驗</h1>
        
        <div class="difficulty-controls">
            <label for="difficulty">難度選擇：</label>
            <select id="difficulty">
                <option value="easy">簡單 (約25%填空)</option>
                <option value="medium" selected>中等 (約50%填空)</option>
                <option value="hard">困難 (約75%填空)</option>
                <option value="expert">專家 (幾乎全部填空)</option>
            </select>
            <button id="regenerate" style="margin-left: auto;">重新生成填空</button>
        </div>
        
        <div class="progress-container">
            <div class="progress">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="progress-info">
                <span>完成進度：</span>
                <span id="progress-text">0/0 (0%)</span>
            </div>
        </div>
        
        <form id="quiz-form">
            <div id="quiz-content">
                <!-- 測驗內容會在JavaScript中動態生成 -->
            </div>
            
            <div class="buttons">
                <button type="button" id="reset">重設</button>
                <button type="button" id="show-answers">顯示答案</button>
                <button type="button" id="check-results" class="results-button">查看成績</button>
                <button type="submit">提交</button>
            </div>
        </form>
    </div>
    
    <!-- 成績結果模態框 -->
    <div id="score-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal">&times;</span>
            <div class="modal-header">
                <h2>測驗成績</h2>
            </div>
            <div class="score-display">
                <div class="score-circle" id="score-percentage">--</div>
                <div class="grade" id="grade-display">評級: --</div>
                <div class="feedback" id="feedback-text">--</div>
            </div>
            <div class="score-details">
                <p>總題數: <span id="total-questions">--</span></p>
                <p>答對題數: <span id="correct-answers">--</span></p>
                <p>答錯題數: <span id="wrong-answers">--</span></p>
                <p>未作答題數: <span id="unanswered">--</span></p>
            </div>
            <div class="modal-actions">
                <button id="show-correct-answers">顯示正確答案</button>
                <button id="close-modal-button">繼續練習</button>
            </div>
        </div>
    </div>

    <script>
        // 法條內容 - 多行格式
        const lawSections = [
            {
                title: "第一章 總則",
                articles: [
                    {
                        id: "1",
                        content: [
                            "為加強管理能源，促進能源合理及有效使用，特制定本法。",
                            "中央主管機關為確保全國能源供應穩定及安全，考量環境衝擊及兼顧經濟發展，應擬訂能源發展綱領，報行政院核定施行。"
                        ]
                    },
                    {
                        id: "2",
                        content: [
                            "本法所稱能源如左：",
                            "一、石油及其產品。",
                            "二、煤炭及其產品。",
                            "三、天然氣。",
                            "四、核子燃料。",
                            "五、電能。",
                            "六、其他經中央主管機關指定為能源者。"
                        ]
                    },
                    {
                        id: "3",
                        content: [
                            "本法所稱主管機關：在中央為經濟部；在直轄市為直轄市政府；在縣（市）為縣（市）政府。"
                        ]
                    },
                    {
                        id: "4",
                        content: [
                            "本法所稱能源供應事業，係指經營能源輸入、輸出、生產、運送、儲存、銷售等業務之事業。"
                        ]
                    },
                    {
                        id: "5",
                        content: [
                            "中央主管機關得依預算法之規定，設置能源研究發展特種基金，訂定計畫，加強能源之研究發展工作。",
                            "前項基金之用途範圍如左：",
                            "一、能源開發技術之研究發展及替代能源之研究。",
                            "二、能源合理有效使用及節約技術、方法之研究發展。",
                            "三、能源經濟分析及其情報資料之蒐集。",
                            "四、能源規劃及技術等專業人員之培訓。",
                            "五、其他經核定之支出。",
                            "法人或個人為前項第一款、第二款之研究，具有實用價值者，得予獎勵或補助。",
                            "中央主管機關應每年將能源研究發展計畫及基金運用成效，專案報告立法院。"
                        ]
                    },
                    {
                        id: "5-1",
                        content: [
                            "能源研究發展基金之來源如下：",
                            "一、綜合電業、石油煉製業及石油輸入業經營能源業務收入之提撥。",
                            "二、基金之孳息。",
                            "三、能源技術服務、權利金、報酬金及其他有關收入。",
                            "前項第一款之提撥，由中央主管機關就綜合電業、石油煉製業及石油輸入業每年經營能源業務收入之千分之五範圍內收取。",
                            "第一項第一款之事業已依其他法律規定繳交電能或石油基金者，免收取能源研究發展基金。"
                        ]
                    }
                ]
            },
            {
                title: "第二章 能源供應",
                articles: [
                    {
                        id: "6",
                        content: [
                            "能源供應事業經營能源業務，應遵行中央主管機關關於能源之調節、限制、禁止之規定。",
                            "經中央主管機關指定之能源產品，其輸入、輸出、生產、銷售業務，非經許可不得經營。",
                            "前項許可管理辦法，由中央主管機關訂定，並送立法院。"
                        ]
                    },
                    {
                        id: "7",
                        content: [
                            "能源供應事業經營能源業務，達中央主管機關規定之數量者，應依照中央主管機關之規定，辦理左列事項：",
                            "一、申報經營資料。",
                            "二、設置能源儲存設備。",
                            "三、儲存安全存量。",
                            "依前項第二款規定設置儲存設備，於課徵營利事業所得稅時，得按二年加速折舊。但在二年內如未折舊足額，得於所得稅法規定之耐用年限一年或分年繼續折舊，至折足為止。"
                        ]
                    }
                ]
            },
            {
                title: "第三章 能源使用與查核",
                articles: [
                    {
                        id: "8",
                        content: [
                            "經中央主管機關指定之既有能源用戶所使用之照明、動力、電熱、空調、冷凍冷藏或其他使用能源之設備，其能源之使用及效率，應符合中央主管機關所定節約能源之規定。",
                            "前項能源用戶之指定、使用能源設備之種類、節約能源及能源使用效率之規定，由中央主管機關公告之。"
                        ]
                    },
                    {
                        id: "9",
                        content: [
                            "能源用戶使用能源達中央主管機關規定數量者，應建立能源查核制度，並訂定節約能源目標及執行計畫，報經中央主管機關核備並執行之。"
                        ]
                    },
                    {
                        id: "10",
                        content: [
                            "能源用戶生產蒸汽達中央主管機關規定數量者，應裝設汽電共生設備。",
                            "能源用戶裝設汽電共生設備，有效熱能比率及總熱效率達中央主管機關規定者，得請當地綜合電業收購其生產電能之餘電，與提供系統維修或故障所需備用電力。當地綜合電業除有正當理由，並經中央主管機關核准外，不得拒絕。",
                            "前項收購餘電費率、汽電共生有效熱能比率與總熱效率基準及查驗方式之辦法，及裝設汽電共生之能源用戶與綜合電業相互併聯、電能收購方式、購電與備用電力費率及收購餘電義務之執行期間等事項之辦法，由中央主管機關定之。"
                        ]
                    },
                    {
                        id: "11",
                        content: [
                            "能源用戶使用能源達中央主管機關規定數量者，應依其能源使用量級距，自置或委託一定名額之技師或合格能源管理人員負責執行第八條、第九條及第十二條中央主管機關規定之業務。",
                            "前項能源使用級距、技師或能源管理人員之名額、資格、訓練、合格證書取得之程序、條件、撤銷、廢止、查核、管理及其他應遵行事項之辦法，由中央主管機關定之。"
                        ]
                    },
                    {
                        id: "12",
                        content: [
                            "能源用戶使用能源達中央主管機關規定數量者，應向中央主管機關申報使用能源資料。",
                            "前項能源用戶應申報使用能源之種類、數量、項目、效率、申報期間及方式，由中央主管機關公告之。"
                        ]
                    },
                    {
                        id: "14",
                        content: [
                            "廠商製造或進口中央主管機關指定之使用能源設備或器具供國內使用者，其能源設備或器具之能源效率，應符合中央主管機關容許耗用能源之規定，並應標示能源耗用量及其效率。",
                            "不符合前項容許耗用能源規定之使用能源設備或器具，不准進口或在國內銷售。",
                            "未依第一項規定標示之使用能源設備或器具，不得在國內陳列或銷售。",
                            "第一項使用能源設備或器具之種類、容許耗用能源基準與其檢查方式、能源耗用量及其效率之標示事項、方法、檢查方式，由中央主管機關公告之。"
                        ]
                    },
                    {
                        id: "15",
                        content: [
                            "廠商製造或進口中央主管機關指定之車輛供國內使用者，其車輛之能源效率，應符合中央主管機關容許耗用能源之規定，並應標示能源耗用量及其效率。",
                            "不符合前項容許耗用能源規定之車輛，不准進口或在國內銷售。",
                            "未依第一項規定標示之車輛，不得在國內陳列或銷售。",
                            "第一項車輛容許耗用能源基準、能源耗用量與其效率之標示事項、方法、檢查方式、證明文件之核發、撤銷或廢止、管理及其他相關事項之辦法，由中央主管機關會同中央交通主管機關定之。"
                        ]
                    },
                    {
                        id: "15-1",
                        content: [
                            "中央主管機關應依第一條第二項能源發展綱領，就全國能源分期分區供給容量及效率規定，訂定能源開發及使用評估準則，作為國內能源開發及使用之審查準據。"
                        ]
                    },
                    {
                        id: "16",
                        content: [
                            "大型投資生產計畫之能源用戶新設或擴建能源使用設施，其能源使用數量對國家整體能源供需與結構及區域平衡造成重大影響者，應製作能源使用說明書送請受理許可申請之機關，轉送中央主管機關核准後，始得新設或擴建。",
                            "中央主管機關為前項核准前，應依前條所定能源開發及使用評估準則，對能源用戶之使用數量、種類、效率及區位等事項進行審查。",
                            "能源用戶應依前項審查結論，就能源使用數量、種類、效率及設施設置區位切實執行；中央主管機關並應定期追蹤查核其執行情形。",
                            "第一項能源用戶適用之範圍、能源使用說明書之格式及應記載事項，由中央主管機關公告之。"
                        ]
                    },
                    {
                        id: "17",
                        content: [
                            "新建建築物之設計與建造之有關節約能源標準，由建築主管機關會同中央主管機關定之。"
                        ]
                    },
                    {
                        id: "18",
                        content: [
                            "能源用戶裝設中央空氣調節系統，且其冷凍主機容量達中央主管機關規定數額者，應裝設個別電表及線路。",
                            "綜合電業為實施中央空氣調節系統用電之負載管理，得經中央主管機關核准，採行差別費率。",
                            "中央空氣調節系統之能源用戶，其空調電表、分表及線路裝置方式、採用電纜種類及表計規格等事項之規則，由中央主管機關定之。"
                        ]
                    },
                    {
                        id: "19",
                        content: [
                            "中央主管機關於能源供應不足時，得訂定能源管制、限制及配售辦法，報請行政院核定施行之。"
                        ]
                    },
                    {
                        id: "19-1",
                        content: [
                            "中央主管機關得派員或委託專業機構或技師，對於本法公告或指定之能源用戶、使用能源設備、器具或車輛之製造、進口廠商或販賣業者，實施檢查或命其提供有關資料，能源用戶、製造、進口廠商及販賣業者不得規避、妨礙或拒絕。",
                            "實施前項檢查之人員，應主動出示有關執行職務之證明文件或顯示足資辨別之標誌。",
                            "第一項專業機構或技師，其認可之申請、發給、撤銷、廢止、收費及其他遵行事項之管理辦法，由中央主管機關定之。"
                        ]
                    }
                ]
            },
            {
                title: "第四章 罰則",
                articles: [
                    {
                        id: "20",
                        content: [
                            "能源供應事業違反中央主管機關依第六條第一項所為之規定者，主管機關應通知限期辦理；逾期不遵行者，處新臺幣一萬五千元以上十五萬元以下罰鍰，並再限期辦理；逾期仍不遵行者，除加倍處罰外，並得停止其營業或勒令歇業；經主管機關為加倍處罰，仍不遵行者，對其負責人處一年以下有期徒刑、拘役或科或併科新臺幣三十萬元以下罰金。"
                        ]
                    },
                    {
                        id: "20-1",
                        content: [
                            "未經許可而經營中央主管機關指定之能源產品之輸入、輸出、生產、銷售業務者，處一年以下有期徒刑、拘役或科或併科新臺幣三十萬元以下罰金。"
                        ]
                    },
                    {
                        id: "21",
                        content: [
                            "有下列情形之一者，主管機關應通知限期改善；屆期不改善者，處新臺幣二萬元以上十萬元以下罰鍰，並再限期改善；屆期仍不改善者，按次加倍處罰：",
                            "一、未依第七條第一項第一款規定申報經營資料或申報不實。",
                            "二、未依第十一條第一項規定自置或委託技師或合格能源管理人員執行中央主管機關規定之業務。",
                            "三、未依第十二條第一項規定申報使用能源資料或申報不實。",
                            "四、未依第十四條第一項或第十五條第一項規定標示能源耗用量及其效率或標示不實。",
                            "五、違反第十四條第三項或第十五條第三項規定，陳列或銷售未依法標示之使用能源設備、器具或車輛。"
                        ]
                    },
                    {
                        id: "22",
                        content: [
                            "能源供應事業違反第七條第一項第二款、第三款未設置能源儲存設備或儲存安全存量者，主管機關應通知限期辦理；逾期不遵行者，處新台幣十五萬元以上六十萬元以下罰鍰，並再限期辦理；逾期仍不遵行者，得加倍處罰。"
                        ]
                    },
                    {
                        id: "23",
                        content: [
                            "能源用戶違反中央主管機關依第八條所定關於能源使用及效率之規定者，主管機關應限期命其改善或更新設備；屆期不改善或更新設備者，處新臺幣二萬元以上十萬元以下罰鍰，並再限期辦理；屆期仍不改善者，按次加倍處罰。"
                        ]
                    },
                    {
                        id: "24",
                        content: [
                            "有下列情形之一者，主管機關應通知限期辦理；屆期不改善者，處新臺幣三萬元以上十五萬元以下罰鍰，並再限期辦理；屆期仍不改善者，按次加倍處罰：",
                            "一、未依第九條規定建立能源查核制度或未訂定或未執行節約能源目標及計畫。",
                            "二、未依第十條第一項規定裝置汽電共生設備。",
                            "三、違反第十四條第二項或第十五條第二項不准進口或在國內銷售之規定。",
                            "四、違反第十六條第三項規定，超過能源使用數量或未符合能源種類及效率。",
                            "五、違反第十九條之一第一項規定，規避、妨礙或拒絕中央主管機關所為之檢查或要求提供資料之命令。",
                            "六、違反第十九條之一第三項所定之管理辦法。"
                        ]
                    },
                    {
                        id: "25",
                        content: [
                            "能源用戶違反第十六條第一項未經核准而新設或擴建者，中央主管機關得禁止其輸入能源或命能源供應事業停供能源。"
                        ]
                    },
                    {
                        id: "26",
                        content: [
                            "能源用戶違反依第十七條所定之節約能源標準者，得停供其能源。"
                        ]
                    },
                    {
                        id: "27",
                        content: [
                            "違反中央主管機關依第十九條所定之能源管制、限制及配售辦法者，主管機關應通知限期辦理；逾期不遵行者，處新台幣一萬五千元以上十五萬元以下罰鍰，並得停供其能源。"
                        ]
                    }
                ]
            },
            {
                title: "第五章 附則",
                articles: [
                    {
                        id: "29",
                        content: [
                            "本法施行細則，由中央主管機關訂定，報請行政院核定之。"
                        ]
                    },
                    {
                        id: "30",
                        content: [
                            "本法自公布日施行。"
                        ]
                    }
                ]
            }
        ];

        // 用於填空的關鍵詞列表
        const keywords = [
            "能源", "供應", "穩定", "安全", "發展綱領", "行政院", "石油", "煤炭", "天然氣", "核子", 
            "電能", "主管機關", "經濟部", "直轄市政府", "縣市政府", "能源供應事業", "輸入", "輸出", "生產", 
            "運送", "儲存", "銷售", "研究發展", "特種基金", "替代能源", "合理", "有效", "節約", "經濟分析", 
            "情報資料", "規劃", "培訓", "實用", "獎勵", "補助", "綜合電業", "石油煉製業", "石油輸入業", 
            "孳息", "權利金", "報酬金", "千分之五", "調節", "限制", "禁止", "許可", "立法院", "申報", 
            "經營資料", "儲存設備", "安全存量", "營利事業", "二年", "耐用年限", "照明", "動力", "電熱", 
            "空調", "冷凍冷藏", "效率", "節約能源", "公告", "查核制度", "節約能源目標", "執行計畫", "核備", 
            "蒸汽", "汽電共生", "有效熱能比率", "總熱效率", "餘電", "備用電力", "正當理由", "拒絕", "費率", 
            "基準", "查驗", "併聯", "電能收購", "購電", "義務", "技師", "能源管理人員", "級距", "名額", 
            "資格", "訓練", "合格證書", "程序", "條件", "撤銷", "廢止", "查核", "管理", "種類", "數量", 
            "項目", "申報期間", "方式", "設備", "器具", "容許", "耗用能源", "標示", "耗用量", "車輛", 
            "交通主管機關", "分期", "分區", "供給容量", "開發及使用評估準則", "審查準據", "投資", "計畫", 
            "設施", "整體", "供需", "結構", "平衡", "重大影響", "能源使用說明書", "核准", "新設", "擴建", 
            "區位", "格式", "記載事項", "建築物", "設計", "建造", "建築主管機關", "中央空氣調節系統", 
            "冷凍主機", "電表", "線路", "負載管理", "差別費率", "空調電表", "分表", "電纜", "表計", "規格", 
            "不足", "管制", "配售", "派員", "委託", "專業機構", "檢查", "資料", "規避", "妨礙", "拒絕", 
            "證明文件", "標誌", "認可", "申請", "發給", "收費", "遵行事項", "罰鍰", "加倍處罰", "停止營業", 
            "勒令歇業", "負責人", "有期徒刑", "拘役", "科", "併科", "罰金", "改善", "自置", "委託", "更新", 
            "輸入能源", "停供", "施行細則", "公布日"
        ];

        // 檢查詞語是否為關鍵詞
        function isKeyword(word) {
            // 移除可能的標點符號
            const cleanWord = word.replace(/[，。、；：「」『』（）〔〕【】《》〈〉""''？！……—]/g, "");
            if (cleanWord.length <= 1) return false; // 忽略單個字符
            return keywords.includes(cleanWord) || 
                   /^\d+$/.test(cleanWord) || // 數字
                   /[a-zA-Z]/.test(cleanWord) || // 英文字母
                   keywords.some(keyword => cleanWord.includes(keyword) && cleanWord.length > 2); // 包含關鍵詞
        }

        // 創建填空的HTML，根據原詞長度設置寬度
        function createBlankHtml(word, id) {
            // 計算字符寬度 - 中文字符通常是英文的兩倍寬
            const wordLength = word.length;
            // 每個中文字符約16px，每個英文字符約8px，設置最小寬度並為輸入留出一些額外空間
            const widthMultiplier = 16; // 每個字符的寬度倍數
            const minWidth = 30; // 最小寬度（像素）
            const extraSpace = 5; // 額外空間（像素）
            
            // 計算顯示寬度，並確保至少有最小寬度
            const width = Math.max(wordLength * widthMultiplier + extraSpace, minWidth);
            
            return `<input type="text" class="blank-input" data-answer="${word}" id="blank-${id}" style="width: ${width}px;">`;
        }

        // 分割文本並保留標點符號
        function splitTextWithPunctuation(text) {
            // 先將標點符號替換為帶有特殊標記的文本，以便後續識別
            const tempText = text.replace(/([，。、；：「」『』（）〔〕【】《》〈〉""''？！……—])/g, "@@$1@@");
            // 然後按照特殊標記和空格分割文本
            return tempText.split(/@@|\s+/).filter(word => word.trim() !== "");
        }

        // 處理項目編號（如"一、"，"二、"等）
        function processItemNumber(paragraph) {
            const itemMatch = paragraph.match(/^([一二三四五六七八九十]+、|\d+、)/);
            if (itemMatch) {
                const itemNumber = itemMatch[1];
                const contentStartIndex = itemMatch[0].length;
                const content = paragraph.substring(contentStartIndex);
                return {
                    isItem: true,
                    itemNumber: itemNumber,
                    content: content
                };
            } else {
                return {
                    isItem: false,
                    content: paragraph
                };
            }
        }

        // 生成測驗函數 - 統一處理填空選擇邏輯
        function generateQuiz(difficulty) {
            const quizContent = document.getElementById("quiz-content");
            quizContent.innerHTML = "";
            
            let blankCounter = 0;
            const allBlanks = [];
            
            // 遍歷所有章節
            lawSections.forEach(section => {
                const sectionElement = document.createElement("h2");
                sectionElement.textContent = section.title;
                quizContent.appendChild(sectionElement);
                
                // 遍歷每個條文
                section.articles.forEach(article => {
                    const questionElement = document.createElement("div");
                    questionElement.className = "question";
                    
                    // 創建題目標題
                    const titleElement = document.createElement("div");
                    titleElement.className = "article-title";
                    titleElement.textContent = `第 ${article.id} 條：`;
                    questionElement.appendChild(titleElement);
                    
                    const contentElement = document.createElement("div");
                    contentElement.className = "article-content";
                    
                    // 收集整個條文中的所有詞語和關鍵詞
                    let allWords = [];
                    let keywordIndices = [];
                    let paragraphWordCounts = []; // 記錄每個段落的詞語數量，用於後續定位
                    
                    // 第一步：收集所有詞語
                    article.content.forEach(paragraph => {
                        // 處理項目編號
                        const processedItem = processItemNumber(paragraph);
                        
                        let words;
                        if (processedItem.isItem) {
                            // 對於項目，只處理內容部分
                            words = splitTextWithPunctuation(processedItem.content);
                        } else {
                            // 對於普通段落，處理整個段落
                            words = splitTextWithPunctuation(paragraph);
                        }
                        
                        // 記錄這個段落的詞語數量
                        paragraphWordCounts.push(words.length);
                        
                        // 找出所有關鍵詞的索引
                        words.forEach((word, index) => {
                            if (isKeyword(word)) {
                                keywordIndices.push(allWords.length + index);
                            }
                        });
                        
                        // 將這個段落的詞語添加到所有詞語列表中
                        allWords = allWords.concat(words);
                    });
                    
                    // 第二步：選擇要填空的詞語
                    let indicesToBlank = chooseBlankIndices(keywordIndices, difficulty);
                    
                    // 第三步：生成HTML
                    let paragraphStartIndex = 0;
                    
                    article.content.forEach((paragraph, paragraphIndex) => {
                        // 處理項目編號
                        const processedItem = processItemNumber(paragraph);
                        
                        const paragraphElement = document.createElement("div");
                        paragraphElement.className = processedItem.isItem ? "item" : "paragraph";
                        
                        let paragraphText = "";
                        
                        if (processedItem.isItem) {
                            // 添加項目編號
                            paragraphText += `<span class="item-number">${processedItem.itemNumber}</span>`;
                            
                            // 處理內容部分
                            const contentWords = splitTextWithPunctuation(processedItem.content);
                            
                            contentWords.forEach((word, wordIndex) => {
                                const globalIndex = paragraphStartIndex + wordIndex;
                                
                                if (indicesToBlank.includes(globalIndex)) {
                                    paragraphText += createBlankHtml(word, blankCounter);
                                    allBlanks.push({
                                        id: blankCounter,
                                        answer: word
                                    });
                                    blankCounter++;
                                } else {
                                    paragraphText += word;
                                }
                            });
                        } else {
                            // 處理普通段落
                            const words = splitTextWithPunctuation(paragraph);
                            
                            words.forEach((word, wordIndex) => {
                                const globalIndex = paragraphStartIndex + wordIndex;
                                
                                if (indicesToBlank.includes(globalIndex)) {
                                    paragraphText += createBlankHtml(word, blankCounter);
                                    allBlanks.push({
                                        id: blankCounter,
                                        answer: word
                                    });
                                    blankCounter++;
                                } else {
                                    paragraphText += word;
                                }
                            });
                        }
                        
                        // 更新下一個段落的起始索引
                        paragraphStartIndex += paragraphWordCounts[paragraphIndex];
                        
                        paragraphElement.innerHTML = paragraphText;
                        contentElement.appendChild(paragraphElement);
                    });
                    
                    questionElement.appendChild(contentElement);
                    quizContent.appendChild(questionElement);
                });
            });
            
            // 保存答案到表單
            const form = document.getElementById("quiz-form");
            form.dataset.blanks = JSON.stringify(allBlanks);
            
            // 更新進度信息
            updateProgress();
            
            return allBlanks.length;
        }

        // 根據難度選擇要填空的詞語索引
        function chooseBlankIndices(keywordIndices, difficulty) {
            // 根據難度決定要填空的數量
            let percentToBlank;
            switch (difficulty) {
                case "easy":
                    percentToBlank = 0.25;
                    break;
                case "medium":
                    percentToBlank = 0.5;
                    break;
                case "hard":
                    percentToBlank = 0.75;
                    break;
                case "expert":
                    percentToBlank = 0.95;
                    break;
                default:
                    percentToBlank = 0.5;
            }
            
            // 計算要填空的數量
            const numToBlank = Math.ceil(keywordIndices.length * percentToBlank);
            
            // 隨機選擇要填空的索引
            const selectedIndices = new Set();
            while (selectedIndices.size < numToBlank && selectedIndices.size < keywordIndices.length) {
                const randomIndex = Math.floor(Math.random() * keywordIndices.length);
                selectedIndices.add(keywordIndices[randomIndex]);
            }
            
            return Array.from(selectedIndices);
        }

        // 更新進度條
        function updateProgress() {
            const inputs = document.querySelectorAll('.blank-input');
            let filledCount = 0;
            
            inputs.forEach(input => {
                if (input.value.trim() !== '') {
                    filledCount++;
                }
            });
            
            const totalInputs = inputs.length;
            const progressPercentage = totalInputs > 0 ? (filledCount / totalInputs) * 100 : 0;
            document.getElementById('progress-bar').style.width = progressPercentage + '%';
            document.getElementById('progress-text').textContent = `${filledCount}/${totalInputs} (${progressPercentage.toFixed(1)}%)`;
        }

        // 顯示答案
        function showAnswers() {
            const inputs = document.querySelectorAll('.blank-input');
            inputs.forEach(input => {
                input.value = input.dataset.answer;
            });
            updateProgress();
        }
        
        // 計算成績
        function calculateScore() {
            const inputs = document.querySelectorAll('.blank-input');
            let totalQuestions = inputs.length;
            let correctAnswers = 0;
            let wrongAnswers = 0;
            let unanswered = 0;
            
            inputs.forEach(input => {
                const userAnswer = input.value.trim();
                const correctAnswer = input.dataset.answer;
                
                if (userAnswer === '') {
                    unanswered++;
                } else if (userAnswer === correctAnswer) {
                    correctAnswers++;
                    input.classList.add('correct-answer');
                } else {
                    wrongAnswers++;
                    input.classList.add('wrong-answer');
                }
            });
            
            const scorePercentage = totalQuestions > 0 ? 
                Math.round((correctAnswers / totalQuestions) * 100) : 0;
            
            let grade;
            let feedback;
            
            if (scorePercentage >= 90) {
                grade = "優等 (A+)";
                feedback = "太棒了！你對能源管理法有極深入的理解！";
            } else if (scorePercentage >= 80) {
                grade = "甲等 (A)";
                feedback = "表現優秀，你已經熟悉能源管理法的大部分內容！";
            } else if (scorePercentage >= 70) {
                grade = "乙等 (B+)";
                feedback = "表現不錯，繼續努力可以更上一層樓！";
            } else if (scorePercentage >= 60) {
                grade = "丙等 (B)";
                feedback = "及格了，但還有提升空間，建議多加練習！";
            } else if (scorePercentage >= 50) {
                grade = "丁等 (C)";
                feedback = "還需要更多學習和記憶，再接再厲！";
            } else {
                grade = "戊等 (D)";
                feedback = "建議重新學習能源管理法的內容，加油！";
            }
            
            return {
                totalQuestions,
                correctAnswers,
                wrongAnswers,
                unanswered,
                scorePercentage,
                grade,
                feedback
            };
        }
        
        // 顯示成績模態框
        function showScoreModal() {
            const score = calculateScore();
            
            document.getElementById('score-percentage').textContent = score.scorePercentage + "%";
            document.getElementById('grade-display').textContent = "評級: " + score.grade;
            document.getElementById('feedback-text').textContent = score.feedback;
            document.getElementById('total-questions').textContent = score.totalQuestions;
            document.getElementById('correct-answers').textContent = score.correctAnswers;
            document.getElementById('wrong-answers').textContent = score.wrongAnswers;
            document.getElementById('unanswered').textContent = score.unanswered;
            
            document.getElementById('score-modal').style.display = "block";
        }
        
        // 關閉模態框
        function closeModal() {
            document.getElementById('score-modal').style.display = "none";
        }
        
        // 顯示正確答案並高亮錯誤
        function showCorrectAndWrongAnswers() {
            const inputs = document.querySelectorAll('.blank-input');
            
            inputs.forEach(input => {
                const userAnswer = input.value.trim();
                const correctAnswer = input.dataset.answer;
                
                if (userAnswer !== correctAnswer) {
                    input.value = correctAnswer;
                    input.classList.add('correct-answer');
                }
            });
            
            closeModal();
        }

        // 事件監聽器設置
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化測驗
            const initialDifficulty = document.getElementById('difficulty').value;
            generateQuiz(initialDifficulty);
            
            // 難度改變時重新生成測驗
            document.getElementById('regenerate').addEventListener('click', function() {
                const difficulty = document.getElementById('difficulty').value;
                generateQuiz(difficulty);
            });
            
            // 重設按鈕
            document.getElementById('reset').addEventListener('click', function() {
                document.querySelectorAll('.blank-input').forEach(input => {
                    input.value = '';
                    input.classList.remove('correct-answer', 'wrong-answer');
                });
                updateProgress();
            });
            
            // 顯示答案按鈕
            document.getElementById('show-answers').addEventListener('click', showAnswers);
            
            // 查看成績按鈕
            document.getElementById('check-results').addEventListener('click', showScoreModal);
            
            // 關閉模態框按鈕
            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('close-modal-button').addEventListener('click', closeModal);
            
            // 顯示正確答案按鈕
            document.getElementById('show-correct-answers').addEventListener('click', showCorrectAndWrongAnswers);
            
            // 監聽所有輸入框的變化
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('blank-input')) {
                    updateProgress();
                }
            });
            
            // 提交表單
            document.getElementById('quiz-form').addEventListener('submit', function(e) {
                e.preventDefault();
                showScoreModal();
            });
            
            // 點擊模態框外部關閉模態框
            window.addEventListener('click', function(e) {
                const modal = document.getElementById('score-modal');
                if (e.target === modal) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>