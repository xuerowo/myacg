<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漫畫詳情 - 我的網漫閱讀</title>
    <link rel="stylesheet" href="common.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
    <style>
        .manga-detail {
            background: var(--background-color);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .manga-info {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .manga-cover {
            width: 100%;
            border-radius: 4px;
        }

        .manga-description {
            margin-top: 1rem;
            line-height: 1.8;
            white-space: pre-line;
        }

        .chapter-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .chapter-item {
            background: var(--secondary-color);
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            position: relative;
        }

        .chapter-item.read {
            opacity: 0.7;
        }

        .chapter-item:hover {
            background: var(--primary-color);
            color: #fff;
        }

        @media (max-width: 768px) {
            .manga-info {
                grid-template-columns: 1fr;
            }

            .manga-cover {
                max-width: 300px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <nav class="navbar">
            <div class="container">
                <h1 @click="goToHome">我的網漫閱讀</h1>
            </div>
        </nav>

        <div class="container">
            <div v-if="manga" class="manga-detail">
                <div class="manga-info">
                    <img :src="manga.coverUrl" :alt="manga.title" class="manga-cover">
                    <div>
                        <h2>{{ manga.title }}</h2>
                        <p>作者：{{ manga.author }}</p>
                        <p>類型：{{ manga.genres?.join(', ') }}</p>
                        <p class="manga-description">{{ manga.description }}</p>
                    </div>
                </div>
                <div class="chapter-list">
                    <div v-for="chapter in manga.chapters" 
                         :key="chapter.number"
                         class="chapter-item"
                         :class="{ read: isChapterRead(chapter) }"
                         @click="goToReader(chapter)">
                        第{{ chapter.number }}話
                    </div>
                </div>
            </div>
            <div v-else class="loading">
                加載中...
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEYS = {
            READ_CHAPTERS: 'read_chapters',
            MANGA_CACHE: 'manga_detail_cache'
        };

        createApp({
            data() {
                return {
                    manga: null,
                    readChapters: JSON.parse(localStorage.getItem(STORAGE_KEYS.READ_CHAPTERS) || '{}')
                }
            },
            methods: {
                async fetchTextFile(path) {
                    try {
                        const response = await axios.get(
                            `https://api.github.com/repos/xuerowo/myacg/contents/${path}`
                        );
                        const binary = atob(response.data.content);
                        const bytes = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) {
                            bytes[i] = binary.charCodeAt(i);
                        }
                        const decoder = new TextDecoder('utf-8');
                        const content = decoder.decode(bytes);
                        return content.trim();
                    } catch (error) {
                        console.error(`Error fetching ${path}:`, error);
                        return '';
                    }
                },
                async loadMangaDetail(title) {
                    try {
                        // 檢查緩存
                        const cacheKey = `manga_detail_${title}`;
                        const cached = localStorage.getItem(cacheKey);
                        if (cached) {
                            const { data, timestamp } = JSON.parse(cached);
                            if (Date.now() - timestamp < 3600000) {
                                this.manga = data;
                                return;
                            }
                        }

                        // 獲取封面
                        const coverResponse = await axios.get(
                            `https://api.github.com/repos/xuerowo/myacg/contents/網漫翻譯/${title}/cover.jpg`
                        );

                        // 獲取漫畫信息
                        const infoPath = `網漫翻譯/${title}/資訊`;
                        const [author, description, genres] = await Promise.all([
                            this.fetchTextFile(`${infoPath}/作者.txt`),
                            this.fetchTextFile(`${infoPath}/簡介.txt`),
                            this.fetchTextFile(`${infoPath}/類型.txt`)
                        ]);

                        // 獲取章節列表
                        const response = await axios.get(
                            `https://api.github.com/repos/xuerowo/myacg/contents/網漫翻譯/${title}`
                        );

                        const chapters = response.data
                            .filter(item => 
                                item.type === 'dir' && !isNaN(parseInt(item.name))
                            )
                            .map(item => ({
                                number: parseInt(item.name),
                                path: item.path
                            }))
                            .sort((a, b) => a.number - b.number);

                        this.manga = {
                            title,
                            coverUrl: coverResponse.data.download_url,
                            author,
                            description,
                            genres: genres.split(',').map(g => g.trim()),
                            chapters
                        };

                        // 更新緩存
                        localStorage.setItem(cacheKey, JSON.stringify({
                            data: this.manga,
                            timestamp: Date.now()
                        }));
                    } catch (error) {
                        console.error('Error loading manga detail:', error);
                    }
                },
                isChapterRead(chapter) {
                    return this.readChapters[this.manga.title]?.includes(chapter.number);
                },
                goToHome() {
                    window.location.href = 'index.html';
                },
                goToReader(chapter) {
                    const params = new URLSearchParams({
                        title: this.manga.title,
                        chapter: chapter.number
                    });
                    window.location.href = `reader.html?${params.toString()}`;
                }
            },
            mounted() {
                const params = new URLSearchParams(window.location.search);
                const title = params.get('title');
                if (title) {
                    this.loadMangaDetail(title);
                } else {
                    window.location.href = 'index.html';
                }
            }
        }).mount('#app');
    </script>
</body>
</html>